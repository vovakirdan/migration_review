migration_review  
Yandex code review example
---
> Привет!
Я внимательно просмотрел твои решения по задачам миграции данных и создания сервиса для поиска фильмов. Отличная работа в целом! Ниже я предоставлю подробный код-ревью, полезные ссылки для изучения и рекомендации по улучшению твоего кода.

# Задача 1: Миграция данных между хранилищами
## Код-ревью
### 1. SQL-запрос в функции `extract()`
#### Проблема:

* SQL-запрос сложен и может не возвращать необходимые данные корректно.
* Использование `GROUP_CONCAT` без соответствующего `GROUP BY` может привести к неверным результатам.
* Конструкция `max(writer, writers)` синтаксически некорректна и непонятна.
#### Рекомендации

* Перепиши SQL-запрос, чтобы он корректно объединял необходимые таблицы и возвращал все нужные поля.
* Используй явные JOIN'ы для соединения таблиц.
#### Пример:

```sql
SELECT
    m.id,
    m.imdb_rating,
    m.genre,
    m.title,
    m.plot AS description,
    m.director,
    GROUP_CONCAT(DISTINCT a.id) AS actor_ids,
    GROUP_CONCAT(DISTINCT w.id) AS writer_ids
FROM movies m
LEFT JOIN movie_actors ma ON m.id = ma.movie_id
LEFT JOIN actors a ON ma.actor_id = a.id
LEFT JOIN movie_writers mw ON m.id = mw.movie_id
LEFT JOIN writers w ON mw.writer_id = w.id
GROUP BY m.id;
```
### 2. Обработка сценаристов в функции `transform()`
#### Проблема:

* Логика обработки `raw_writers` не учитывает возможные значения и может привести к ошибкам.
* Предположение, что `raw_writers` всегда будет начинаться с `'['`, может быть неверным.
#### Рекомендации

* Убедись, что данные сценаристов извлекаются в одном формате.
* Добавь проверку на наличие данных и корректность формата.
### 3. Жестко заданный IP-адрес в функции `load()`
#### Проблема:

* Использование жестко заданного IP-адреса может привести к проблемам при переносе кода на другие системы.
#### Рекомендации:

* Используй переменные окружения или файл конфигурации для указания настроек подключения.
#### Пример:

```python
import os

ES_HOST = os.getenv('ES_HOST', 'localhost')
ES_PORT = int(os.getenv('ES_PORT', 9200))
es = Elasticsearch([{'host': ES_HOST, 'port': ES_PORT}])
```
### 4. Использование `pprint` внутри цикла в функции `transform()`
#### Проблема:

* Вывод большого количества данных в консоль может замедлить выполнение программы и затруднить отладку.
#### Рекомендации:

* Удали или закомментируй вызов `pprint.pprint(document)` после завершения отладки.
### 5. Имена переменных и читаемость кода
#### Проблема:

* Имена переменных с двойным подчеркиванием (`__actors`, `__writers`) могут сбивать с толку.
#### Рекомендации:

* Используй понятные и последовательные имена переменных без лишних символов.
### 6. Обработка ошибок
#### Проблема:

* В коде отсутствует обработка возможных исключений при работе с базой данных и Elasticsearch.
#### Рекомендации:

* Добавь блоки try-except для обработки исключений и логирования ошибок.
#### Пример:

```python
try:
    connection = sqlite3.connect("db.sqlite")
except sqlite3.Error as e:
    print(f"Error connecting to database: {e}")
    return
```
### 7. Соответствие схеме данных Elasticsearch
#### Проблема:

* Структура документа может не полностью соответствовать заданной схеме индекса `movies`.
#### Рекомендации:

* Проверь соответствие полей документа и типов данных требованиям Elasticsearch.
* Убедись, что вложенные поля (`nested`) определены корректно.
## Полезные ссылки
* [Документация по SQLite](https://www.sqlite.org/docs.html)
* [Руководство по SQL JOIN](https://www.sqlsplus.com/sql-joins/)
* [Официальная документация Elasticsearch для Python](https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/index.html)
* [Использование Bulk API в Elasticsearch](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html)
* [Руководство по обработке исключений в Python](https://docs.python.org/3/tutorial/errors.html#handling-exceptions)
# Задача 2: Создание сервиса для поиска по базе фильмов
## Код-ревью
### 1. Отсутствие логики валидации параметров
#### Проблема:

* Функция `validate_args` импортируется, но ее реализация не представлена. Не могу увидеть её и оценить корректность.
Возможны ошибки при отсутствии или некорректности параметров запроса.
#### Рекомендации:

* Пришли функцию `validate_args` или (лучше) используй библиотеки для валидации входных данных, такие как `marshmallow` или `pydantic`.
### 2. Поиск только по полю `title`
#### Проблема:

* Поиск выполняется только по полю `title`, хотя по заданию необходимо искать по нескольким полям.
#### Рекомендации:

* Расширь поля поиска, включив в них `description`, `genre`, `actors_names`, `writers_names`, `directors_names`.
#### Пример:

```python
fields = ["title", "description", "genre", "actors_names", "writers_names", "directors_names"]
body = {
    "query": {
        "multi_match": {
            "query": defaults['search'],
            "fields": fields
        }
    }
} if defaults.get('search') else {"query": {"match_all": {}}}
```
### 3. Жестко заданный IP-адрес Elasticsearch
#### Проблема:

* Жесткое указание IP-адреса затрудняет переносимость и масштабируемость приложения.
#### Рекомендации:

* Используй переменные окружения или конфигурационные файлы для указания настроек подключения.
4. Обработка параметров пагинации
#### Проблема:

* Возможна ошибка при некорректном вводе параметров `limit` и `page`.
#### Рекомендации:

* Добавь проверку и преобразование типов для параметров, а также обработку исключений.
#### Пример:

```python
try:
    limit = int(defaults['limit'])
    page = int(defaults['page'])
except ValueError:
    return abort(422)
```
### 5. Улучшение обработки ошибок и возврата ответов
#### Проблема:

* При возникновении ошибок возвращаются ответы без пояснений.
#### Рекомендации:

* Возвращай информативные сообщения об ошибках в формате JSON.
#### Пример:

```python
return jsonify({"error": "Invalid request parameters"}), 422
```
### 6. Использование порта 80 для запуска приложения
#### Проблема:

* Запуск приложения на порту 80 требует прав администратора и может быть небезопасен.
#### Рекомендации:

* Используй стандартные порты разработки, такие как 8000 или 5000.
### 7. Закрытие подключения к Elasticsearch
#### Проблема:

* Подключение к Elasticsearch закрывается после каждого запроса, что может быть неэффективно.
#### Рекомендации:

* Используй пул соединений или контекстные менеджеры для управления подключением.
#### Пример:

```python
from elasticsearch import Elasticsearch

es_client = Elasticsearch([...])

# Код использования es_client

# es_client закрывается автоматически при завершении программы или не закрывается вовсе, так как Elasticsearch-Python сам управляет подключениями.
```
### 8. Обработка отсутствия фильма
#### Проблема:

* При отсутствии фильма возвращается пустой ответ с кодом 404.
#### Рекомендации:

* Возвращай информативное сообщение об ошибке.
#### Пример:

```python
return jsonify({"error": "Movie not found"}), 404
```
## Полезные ссылки
* [Документация Flask](https://flask.palletsprojects.com/en/stable/)
* [Валидация данных с помощью Marshmallow](https://marshmallow.readthedocs.io/en/stable/marshmallow.validate.html)
* [Elasticsearch Query DSL](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html)
* [Обработка ошибок в Flask](https://flask.palletsprojects.com/en/stable/errorhandling/)
* [Управление конфигурацией приложения Flask](https://flask.palletsprojects.com/en/stable/config/)
## Общий фидбек и рекомендации
* Стиль кода и форматирование:

    * Следуй рекомендациям PEP 8 для повышения читаемости кода.
    * Используй инструменты автоматического форматирования, такие как `black` или `flake8`.
* Версионирование:

    * Используй Git для отслеживания изменений.
    * Пиши информативные сообщения к коммитам.
* Тестирование:

    * Пиши юнит-тесты для ключевых компонентов приложения.
    * Используй `pytest` для удобства написания и запуска тестов.
* Логирование:

    * Включи логирование для отслеживания работы приложения и упрощения отладки.
    * Используй модуль `logging` из стандартной библиотеки Python.
* Управление конфигурацией:

    * Избегай жестко заданных настроек в коде.
    * Используй файлы конфигурации или переменные окружения.
* Документация:

    * Добавь докстринги к функциям и классам.
    * Опиши используемые API и их параметры.
* Обработка ошибок:

    * Предусмотри возможные исключения и обрабатывай их корректно.
    * Возвращай информативные сообщения об ошибках пользователям или клиентам API.
